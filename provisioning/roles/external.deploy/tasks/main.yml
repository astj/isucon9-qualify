- name: Create isucari directory
  become: yes
  become_user: isucon
  file:
    path=/home/isucon/isucari
    state=directory

- name: Deploy isucari
  become: yes
  synchronize:
    src: ../../../../
    dest: /home/isucon/isucari
    delete: no
    recursive: yes
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=.gitignore"
      - "--exclude=provisioning"
      - "--exclude=initial-data/images"
      - "--exclude=webapp/public/upload"

- name: Download image assets
  become: yes
  block:
    - file:
        path: /home/isucon/isucari/initial-data/images
        state: directory
    - unarchive:
        remote_src: yes
        src: https://github.com/isucon/isucon9-qualify/releases/download/v2/bench1.zip
        dest: /home/isucon/isucari/initial-data/images
        creates: /home/isucon/isucari/initial-data/images/6a0ac509966bb13b9ff29e3ed7dbcb7b.jpg
        extra_opts:
          - -j

- name: Chown isucon
  become: yes
  file:
    dest: /home/isucon/isucari
    owner: isucon
    group: isucon
    mode: 0755
    recurse: yes
